<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dodge Hell v2.0</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            background: #111;
            border: 3px solid #444;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            cursor: pointer; /* è®“æ»‘é¼ åœ¨ Canvas ä¸Šè®Šæˆæ‰‹æŒ‡ç‹€ */
        }
    </style>
</head>
<body>
    <canvas id="game" width="400" height="600"></canvas>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        const STATE = {
            MENU: 0,
            PLAYING: 1,
            GAMEOVER: 2
        };
        let currentState = STATE.MENU;
        let difficulty = 'easy'; // 'easy' or 'hard'

        // --- ç©å®¶è¨­å®š ---
        const player = {
            x: 200,
            y: 500,
            size: 40,
            speed: 6,
            maxHp: 3,
            hp: 3,
            invincible: false,      // æ˜¯å¦è™•æ–¼ç„¡æ•µç‹€æ…‹
            invincibleTime: 1000,   // ç„¡æ•µæ™‚é–“ (æ¯«ç§’)
            lastHitTime: 0,         // ä¸Šæ¬¡å—å‚·æ™‚é–“
            blink: true             // ç”¨æ–¼ç„¡æ•µæ™‚çš„é–ƒçˆæ•ˆæœ
        };

        // --- æ§åˆ¶è®Šæ•¸ ---
        let left = false, right = false;
        
        // --- éŠæˆ²è®Šæ•¸ ---
        let obstacles = [];
        let score = 0;
        let spawnTimer = null; // éšœç¤™ç‰©ç”Ÿæˆè¨ˆæ™‚å™¨

        // --- åœ–ç‰‡è¼‰å…¥ (å¦‚æœä½ æœ‰åœ–ç‰‡ï¼Œè«‹è§£é–‹è¨»è§£) ---
        // const obstacleImg = new Image();
        // obstacleImg.src = "obstacle.png";

        // --- äº‹ä»¶ç›£è½ ---
        document.addEventListener("keydown", e => {
            if (e.key === "ArrowLeft") left = true;
            if (e.key === "ArrowRight") right = true;
            
            // éŠæˆ²çµæŸæ™‚æŒ‰ç©ºç™½éµé‡æ–°é–‹å§‹
            if (currentState === STATE.GAMEOVER && e.code === "Space") {
                resetGameToMenu();
            }
        });
        
        document.addEventListener("keyup", e => {
            if (e.key === "ArrowLeft") left = false;
            if (e.key === "ArrowRight") right = false;
        });

        // è™•ç†æ»‘é¼ é»æ“Šé¸å–®
        canvas.addEventListener("mousedown", (e) => {
            if (currentState === STATE.MENU) {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // ç°¡å–®æ¨¡å¼æŒ‰éˆ•å€åŸŸ (å¤§ç´„ä½ç½®)
                if (clickX > 100 && clickX < 300 && clickY > 250 && clickY < 310) {
                    startGame('easy');
                }
                // å›°é›£æ¨¡å¼æŒ‰éˆ•å€åŸŸ
                if (clickX > 100 && clickX < 300 && clickY > 330 && clickY < 390) {
                    startGame('hard');
                }
            } else if (currentState === STATE.GAMEOVER) {
                resetGameToMenu();
            }
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        function spawnObstacle() {
            if (currentState !== STATE.PLAYING) return;

            const w = 50, h = 50;
            const x = Math.random() * (canvas.width - w);
            
            // å›°é›£æ¨¡å¼ä¸‹ï¼Œéšœç¤™ç‰©æœƒæœ‰æ°´å¹³é€Ÿåº¦ (vx)
            let vx = 0;
            if (difficulty === 'hard') {
                // éš¨æ©Ÿçµ¦äºˆ -3 åˆ° 3 ä¹‹é–“çš„æ°´å¹³é€Ÿåº¦ï¼Œä¸”é¿å…æ¥è¿‘ 0
                vx = (Math.random() - 0.5) * 6;
                if (Math.abs(vx) < 1) vx = 2; 
            }

            obstacles.push({
                x,
                y: -100,
                w,
                h,
                speed: 3 + Math.random() * 4 + (score * 0.01), // éš¨åˆ†æ•¸å¢åŠ é€Ÿåº¦
                vx: vx // æ°´å¹³é€Ÿåº¦
            });
        }

        function startGame(selectedDifficulty) {
            difficulty = selectedDifficulty;
            currentState = STATE.PLAYING;
            score = 0;
            obstacles = [];
            player.hp = player.maxHp;
            player.x = canvas.width / 2;
            player.invincible = false;
            
            // æ ¹æ“šé›£åº¦èª¿æ•´ç”Ÿæˆé »ç‡
            let spawnRate = difficulty === 'hard' ? 700 : 900;
            if (spawnTimer) clearInterval(spawnTimer);
            spawnTimer = setInterval(spawnObstacle, spawnRate);
        }

        function resetGameToMenu() {
            currentState = STATE.MENU;
            if (spawnTimer) clearInterval(spawnTimer);
        }

        function drawMenu() {
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            
            // æ¨™é¡Œ
            ctx.font = "bold 50px Arial";
            ctx.fillText("DODGE HELL", canvas.width / 2, 150);
            
            // æŒ‰éˆ•æ¨£å¼
            ctx.font = "30px Arial";
            
            // ç°¡å–®æŒ‰éˆ•
            ctx.fillStyle = "#4CAF50"; // ç¶ è‰²
            ctx.fillRect(100, 250, 200, 60);
            ctx.fillStyle = "white";
            ctx.fillText("ç°¡å–®æ¨¡å¼", canvas.width / 2, 290);

            // å›°é›£æŒ‰éˆ•
            ctx.fillStyle = "#F44336"; // ç´…è‰²
            ctx.fillRect(100, 330, 200, 60);
            ctx.fillStyle = "white";
            ctx.fillText("å›°é›£æ¨¡å¼", canvas.width / 2, 370);

            ctx.font = "16px Arial";
            ctx.fillStyle = "#aaa";
            ctx.fillText("è«‹é»æ“Šé¸é …é–‹å§‹", canvas.width / 2, 500);
        }

        function drawUI() {
            // åˆ†æ•¸
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.textAlign = "left";
            ctx.fillText("Score: " + score, 20, 30);

            // è¡€é‡ (ç•«æ„›å¿ƒ)
            let hearts = "";
            for(let i=0; i<player.hp; i++) {
                hearts += "â¤ï¸";
            }
            ctx.textAlign = "right";
            ctx.fillText(hearts, canvas.width - 20, 30);
        }

        function update() {
            // ç„¡æ•µæ™‚é–“é–ƒçˆé‚è¼¯
            if (player.invincible) {
                if (Date.now() - player.lastHitTime > player.invincibleTime) {
                    player.invincible = false;
                    player.blink = true;
                } else {
                    // æ¯ 100ms åˆ‡æ›ä¸€æ¬¡é¡¯ç¤ºç‹€æ…‹
                    player.blink = Math.floor(Date.now() / 100) % 2 === 0;
                }
            } else {
                player.blink = true;
            }

            // ç©å®¶ç§»å‹•
            if (left) player.x -= player.speed;
            if (right) player.x += player.speed;
            player.x = Math.max(20, Math.min(canvas.width - 20, player.x));

            // æ›´æ–°éšœç¤™ç‰©
            obstacles.forEach(o => {
                o.y += o.speed;
                o.x += o.vx; // åŠ ä¸Šæ°´å¹³ç§»å‹•

                // å›°é›£æ¨¡å¼ï¼šç¢°åˆ°ç‰†å£åå½ˆ
                if (difficulty === 'hard') {
                    if (o.x <= 0 || o.x + o.w >= canvas.width) {
                        o.vx *= -1;
                    }
                }

                // ç¢°æ’åˆ¤å®š
                // åªæœ‰ç•¶ç©å®¶ä¸æ˜¯ç„¡æ•µç‹€æ…‹æ™‚æ‰åˆ¤å®šå‚·å®³
                if (!player.invincible &&
                    o.x < player.x + 15 &&
                    o.x + o.w > player.x - 15 &&
                    o.y < player.y + 15 &&
                    o.y + o.h > player.y - 15
                ) {
                    player.hp--;
                    player.invincible = true;
                    player.lastHitTime = Date.now();

                    if (player.hp <= 0) {
                        currentState = STATE.GAMEOVER;
                        if (spawnTimer) clearInterval(spawnTimer);
                    }
                }
            });

            // ç§»é™¤è¶…å‡ºç•«é¢çš„éšœç¤™ç‰©
            // æ³¨æ„ï¼šå› ç‚ºæœ‰å·¦å³ç§»å‹•ï¼Œæˆ‘å€‘åªæª¢æŸ¥ Y è»¸æ˜¯å¦è¶…å‡ºåº•éƒ¨
            obstacles = obstacles.filter(o => o.y < canvas.height + 100);
            
            if(currentState === STATE.PLAYING) score++;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (currentState === STATE.MENU) {
                drawMenu();
                requestAnimationFrame(draw);
                return;
            }

            // ç¹ªè£½ç©å®¶ (å¦‚æœæ˜¯ç„¡æ•µä¸” blink ç‚º falseï¼Œå°±ä¸ç•«ï¼Œè£½é€ é–ƒçˆæ„Ÿ)
            if (player.blink) {
                ctx.font = player.size + "px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("ğŸ‘¾", player.x, player.y);
            }

            // ç¹ªè£½éšœç¤™ç‰©
            obstacles.forEach(o => {
                // å¦‚æœä½ æƒ³ç”¨åœ–ç‰‡ï¼Œè«‹æŠŠä¸‹é¢ä¸‰è¡Œè¨»è§£æ‰ï¼Œä¸¦è§£é–‹ ctx.drawImage
                ctx.font = "40px Arial";
                ctx.textAlign = "left";
                ctx.fillText("ğŸ”¥", o.x, o.y + 40); 
                
                // ctx.drawImage(obstacleImg, o.x, o.y, o.w, o.h);
            });

            drawUI();

            if (currentState === STATE.GAMEOVER) {
                ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = "red";
                ctx.font = "bold 50px Arial";
                ctx.textAlign = "center";
                ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2);
                
                ctx.fillStyle = "white";
                ctx.font = "30px Arial";
                ctx.fillText("Score: " + score, canvas.width / 2, canvas.height / 2 + 50);
                
                ctx.font = "20px Arial";
                ctx.fillStyle = "#aaa";
                ctx.fillText("é»æ“Šç•«é¢æˆ–æŒ‰ç©ºç™½éµè¿”å›é¸å–®", canvas.width / 2, canvas.height / 2 + 100);
            } else {
                update();
            }

            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
